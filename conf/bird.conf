/* itforprof.com by Konstantin Tyutyunnik */

log syslog all;

/* Set your router ID (one of the loopback IPs or any stable IP) */
router id ${ROUTER_ID};

/* Define your AS */
define MY_AS = ${LOCAL_AS};

/* BGP Communities */
define COMM_RU_COMBINED   = (MY_AS, 100);
define COMM_BLOCKED_SMART  = (MY_AS, 101);
define COMM_RKN_SUBNETS   = (MY_AS, 102);
define COMM_GOV_NETS      = (MY_AS, 103);
define COMM_CUSTOM_USER   = (MY_AS, 104);
# define COMM_RESERVED    = (MY_AS, 105); # Reserved for future use

/* Dedicated table for exported prefixes */
ipv4 table t_bgp_prefixes;

protocol device {
    scan time 10;
}

/* Load generated prefixes */
protocol static bgp_prefixes {
    ipv4 { table t_bgp_prefixes; };
    include "/etc/bird/prefixes.bird";
}

/* --- Export Filters Examples --- */

# Filter: Export only RU Combined (community 100) EXCLUDING blocked lists (101-105)
filter export_only_ru {
    if (bgp_community ~ [(MY_AS, 101..105)]) then reject;
    if (COMM_RU_COMBINED ~ bgp_community) then accept;
    reject;
}

# Filter: Export only special networks (101-105) EXCLUDING RU (100)
# Use this if you want blocked lists but NOT the whole RU mainland
filter export_comm101_105 {
    if (COMM_RU_COMBINED ~ bgp_community) then reject;
    if (COMM_BLOCKED_SMART ~ bgp_community) then accept;
    if (COMM_RKN_SUBNETS ~ bgp_community) then accept;
    if (COMM_GOV_NETS    ~ bgp_community) then accept;
    if (COMM_CUSTOM_USER ~ bgp_community) then accept;
    reject;
}

# Filter: Export only special networks (101-104) without RU check
filter export_special_networks {
    # Using range for cleaner logic (101 to 104)
    if (bgp_community ~ [(MY_AS, 101..104)]) then accept;
    reject;
}

# Multi-filter example: Complex logic
filter export_complex_logic {
    # Accept if Custom Lists / Services (104)
    if (COMM_CUSTOM_USER ~ bgp_community) then accept;
    
    # Reject RU Mainland (100) explicitly
    if (COMM_RU_COMBINED ~ bgp_community) then reject;
    
    # Accept everything else if it belongs to our prefixes
    if (proto = "bgp_prefixes") then accept;
    
    reject;
}

/* Template for BGP clients */
template bgp t_client {
    local as MY_AS;
    multihop;
    hold time 240;
    passive on;
    ipv4 {
        table t_bgp_prefixes;
        import none;
        export filter {
            if proto = "bgp_prefixes" then accept;
            reject;
        };
        next hop self;
        export limit 100000 action disable;
    };
}

/* Example protocols using filters */

# Client receiving only RU networks
/*
protocol bgp client_ru from t_client {
    neighbor 192.0.2.2 as 65002;
    ipv4 {
        export filter export_only_ru;
    };
}
*/

# Client receiving only special networks
/*
protocol bgp client_special from t_client {
    neighbor 192.0.2.3 as 65003;
    ipv4 {
        export filter export_comm101_105;
    };
}
*/

/* Dynamic neighbors */
/*
protocol bgp any_client from t_client {
    neighbor range 192.168.0.0/16 as 64999;
}
*/
