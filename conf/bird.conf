/* itforprof.com by Konstantin Tyutyunnik */

/*
 * Local settings: router id, MY_AS, logging.
 * Create this file with your own values, e.g.:
 *
 *   log syslog all;
 *   router id 10.0.0.1;
 *   define MY_AS = 65000;
 */
include "/etc/bird/local-settings.conf";

/* BGP Communities */
define COMM_RU_COMBINED   = (MY_AS, 100);
define COMM_BLOCKED_SMART  = (MY_AS, 101);
define COMM_RKN_SUBNETS   = (MY_AS, 102);
define COMM_GOV_NETS      = (MY_AS, 103);
define COMM_CUSTOM_USER   = (MY_AS, 104);
define COMM_BLOCKED_SUM   = (MY_AS, 105);
define COMM_BLOCKED_IP    = (MY_AS, 106);
define COMM_STRIPE        = (MY_AS, 107);
define COMM_BYTEDANCE     = (MY_AS, 108);
define COMM_AKAMAI        = (MY_AS, 109);
define COMM_ROBLOX        = (MY_AS, 110);

/* Dedicated table for exported prefixes */
ipv4 table t_bgp_prefixes;

protocol device {
    scan time 10;
}

/* Load generated prefixes */
protocol static bgp_prefixes {
    ipv4 { table t_bgp_prefixes; };
    include "/etc/bird/prefixes.bird";
}

/* --- Export Filters --- */

# Filter: Export only RU Combined (community 100) EXCLUDING blocked lists (101-110)
filter export_only_ru {
    if (bgp_community ~ [(MY_AS, 101..110)]) then reject;
    if (COMM_RU_COMBINED ~ bgp_community) then accept;
    reject;
}

# Filter: Export only special networks (101-110) EXCLUDING RU (100)
# Use this if you want blocked lists but NOT the whole RU mainland
filter export_blocked_lists {
    if (COMM_RU_COMBINED ~ bgp_community) then reject;
    if (bgp_community ~ [(MY_AS, 101..110)]) then accept;
    reject;
}

# Filter: Export only special networks (101-110) without RU check
filter export_special_networks {
    if (bgp_community ~ [(MY_AS, 101..110)]) then accept;
    reject;
}

# Multi-filter example: Complex logic
filter export_complex_logic {
    # Accept if Custom Lists / Services (104)
    if (COMM_CUSTOM_USER ~ bgp_community) then accept;

    # Reject RU Mainland (100) explicitly
    if (COMM_RU_COMBINED ~ bgp_community) then reject;

    # Accept everything else if it belongs to our prefixes
    if (proto = "bgp_prefixes") then accept;

    reject;
}

/* Template for BGP clients */
template bgp t_client {
    local as MY_AS;
    multihop;
    hold time 240;
    passive on;
    ipv4 {
        table t_bgp_prefixes;
        import none;
        export filter {
            if proto = "bgp_prefixes" then accept;
            reject;
        };
        next hop self;
        export limit 200000 action disable;
    };
}

/*
 * BGP peers - create per-peer configs in /etc/bird/peers.d/*.conf, e.g.:
 *
 *   protocol bgp my_peer from t_client {
 *       neighbor 192.0.2.2 as 65002;
 *       ipv4 { export filter export_only_ru; };
 *   }
 */
include "/etc/bird/peers.d/*.conf";
