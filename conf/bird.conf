/* itforprof.com by Konstantin Tyutyunnik */

log syslog all;

/* Set your router ID (one of the loopback IPs or any stable IP) */
router id ${ROUTER_ID};

/* Define your AS */
define MY_AS = ${LOCAL_AS};

/* BGP Communities */
define COMM_RU_COMBINED   = (MY_AS, 100);
define COMM_BLOCKED_BASE  = (MY_AS, 101);
define COMM_RKN_SUBNETS   = (MY_AS, 102);
define COMM_CUSTOM_USER   = (MY_AS, 104);
define COMM_GOV_NETS      = (MY_AS, 105);
define COMM_OTHER_SERVICE = (MY_AS, 107);

/* Dedicated table for exported prefixes */
ipv4 table t_bgp_prefixes;

protocol device {
    scan time 10;
}

/* Load generated prefixes */
protocol static bgp_prefixes {
    ipv4 { table t_bgp_prefixes; };
    include "/etc/bird/prefixes.bird";
}

/* --- Export Filters Examples --- */

# Filter: Export only RU Combined (community 100)
filter export_only_comm100 {
    if (COMM_RU_COMBINED ~ bgp_community) then accept;
    reject;
}

# Filter: Export only Blocked/Subnets/Gov/Custom/Other (101-107)
filter export_special_networks {
    if (COMM_BLOCKED_BASE ~ bgp_community) then accept;
    if (COMM_RKN_SUBNETS  ~ bgp_community) then accept;
    if (COMM_CUSTOM_USER  ~ bgp_community) then accept;
    if (COMM_GOV_NETS     ~ bgp_community) then accept;
    if (COMM_OTHER_SERVICE ~ bgp_community) then accept;
    reject;
}

# Multi-filter example: Complex logic
filter export_complex_logic {
    # Accept if 104 (Custom) or 105 (Gov)
    if (bgp_community ~ [COMM_CUSTOM_USER, COMM_GOV_NETS]) then accept;
    
    # Reject 100 (RU Combined) explicitly
    if (COMM_RU_COMBINED ~ bgp_community) then reject;
    
    # Accept everything else if it belongs to our prefixes
    if (proto = "bgp_prefixes") then accept;
    
    reject;
}

/* Template for BGP clients */
template bgp t_client {
    local as MY_AS;
    multihop;
    hold time 240;
    passive on;
    ipv4 {
        table t_bgp_prefixes;
        import none;
        export filter {
            if proto = "bgp_prefixes" then accept;
            reject;
        };
        next hop self;
        export limit 100000 action disable;
    };
}

/* Example protocols using filters */

# Client receiving only RU networks
/*
protocol bgp client_ru from t_client {
    neighbor 192.0.2.2 as 65002;
    ipv4 {
        export filter export_only_comm100;
    };
}
*/

# Client receiving only special networks
/*
protocol bgp client_special from t_client {
    neighbor 192.0.2.3 as 65003;
    ipv4 {
        export filter export_special_networks;
    };
}
*/

/* Dynamic neighbors */
/*
protocol bgp any_client from t_client {
    neighbor range 192.168.0.0/16 as 64999;
}
*/
